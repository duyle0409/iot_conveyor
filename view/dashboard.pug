doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    title ESP System Control
    link(rel="stylesheet", href="/style.css")
  body
    h1 HỆ THỐNG PHÂN LOẠI SẢN PHẨM

    // Khu vực điều khiển chính
    .controls
      button(onclick="sendCmd('ON')") Bật Máy (Start)
      button(onclick="sendCmd('OFF')") Tắt Máy (Stop)
      button(onclick="sendCmd('STOP')") Dừng Khẩn Cấp

    // --- KHU VỰC CHỈNH TỐC ĐỘ (MỚI) ---
    .controls(style="margin-top: 20px; padding: 15px; border-top: 1px solid #ccc;")
      h3 Điều chỉnh Tốc độ (PWM)
      p Tốc độ hiện tại: 
        span#currentSpeed(style="font-weight:bold; color: #e74c3c; font-size: 1.5em;") 50
      
      div(style="margin-top: 10px;")
        button(onclick="sendCmd('SPEED:1')" style="background-color: #3498db;") Mức 1 (50)
        button(onclick="sendCmd('SPEED:2')" style="background-color: #2980b9;") Mức 2 (70)
        button(onclick="sendCmd('SPEED:3')" style="background-color: #2c3e50;") Mức 3 (100)

    // Trạng thái hệ thống
    .status
      p Trạng thái: 
        span#systemStatus Chưa kết nối...
      .colorCounters
        span#countXanh.badge.xanh Xanh: 0
        span#countDo.badge.do Đỏ: 0
        span#countVang.badge.vang Vàng: 0
    .filters(style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;")
      form(method="GET" action="/dashboard" style="display: flex; gap: 10px;")
        // Lọc theo màu
        select(name="filterColor")
          option(value="") -- Tất cả màu --
          option(value="blue" selected=filters.filterColor=='blue') Có màu Xanh
          option(value="red" selected=filters.filterColor=='red') Có màu Đỏ
          option(value="green" selected=filters.filterColor=='green') Có màu Vàng

        // Sắp xếp theo cột
        select(name="sortBy")
          option(value="startAt" selected=filters.sortBy=='startAt') Thời gian
          option(value="totalBlue" selected=filters.sortBy=='totalBlue') Số lượng Xanh
          option(value="totalRed" selected=filters.sortBy=='totalRed') Số lượng Đỏ

        // Thứ tự
        select(name="order")
          option(value="desc" selected=filters.order=='desc') Giảm dần
          option(value="asc" selected=filters.order=='asc') Tăng dần

        button(type="submit" style="background: #34495e; color: white; padding: 5px 15px; border-radius: 4px;") Áp dụng
        a(href="/dashboard" style="text-decoration: none; color: #7f8c8d; padding-top: 5px;") Xóa lọc
    // Bảng thống kê
    h2 Lịch sử Hoạt động
    table#sessionTable.session-table
      thead
        tr
          th #
          th Bắt đầu
          th Kết thúc
          th Thời gian
          th Xanh
          th Đỏ
          th Vàng
          th Tổng
      tbody
        each session, index in sessionList
          - const start = new Date(session.startAt)
          - const end = new Date(session.endAt)
          - const durationSec = Math.floor((end - start) / 1000)
          - const durationStr = `${Math.floor(durationSec / 60)}m ${durationSec % 60}s`
          - const total = session.totalBlue + session.totalRed + session.totalGreen
          tr
            td #{index + 1}
            td #{start.toLocaleString()}
            td #{end.toLocaleString()}
            td #{durationStr}
            td #{session.totalBlue}
            td #{session.totalRed}
            td #{session.totalGreen}
            td #{total}

    script(src="/socket.io/socket.io.js")
    script(src="/script.js")